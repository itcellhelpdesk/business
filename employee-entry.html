<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Registration</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
        }
        .card-header {
            background: linear-gradient(135deg, #0e56d1, #2483C5);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        .form-label {
            font-weight: 600;
            color: #333;
        }
        .required:after {
            content: " *";
            color: #dc3545;
        }
        .btn-primary {
            background: linear-gradient(135deg, #0e56d1, #2483C5);
            border: none;
            font-weight: 600;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            font-weight: 600;
        }
        .btn-reset {
            background: linear-gradient(135deg, #6c757d, #8e9ba7);
            border: none;
            font-weight: 600;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0e56d1;
            box-shadow: 0 0 0 0.2rem rgba(14, 86, 209, 0.25);
        }
        .section-title {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 8px;
            margin-bottom: 15px;
            color: #0e56d1;
            font-weight: 600;
        }
    </style>
</head>
<body style="background-color:#e8f0fe;">
    <div class="container-fluid mt-3" style="min-width:100%">
        <div class="row justify-content-center">
            <h4 class="mb-3">Employee Registration Form</h4>
            <div class="col-lg-10" style="min-width:100%">
                <div class="card">
                    
                    <div class="card-body p-4">
                        <form id="employeeForm">
                            <!-- Office Information -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="section-title">Office Information</h5>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="mainOffice" class="form-label required">Main Office</label>
                                    <input type="text" class="form-control" id="mainOffice" name="mainOffice" readonly>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="subOffice" class="form-label required">Sub Office</label>
                                    <input type="text" class="form-control" id="subOffice" name="subOffice" readonly>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="date" class="form-label required">Date</label>
                                    <input type="text" class="form-control" id="date" name="date" readonly>
                                </div>
                            </div>

                            <!-- Employee Basic Information -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="section-title">Employee Basic Information</h5>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="employeeName" class="form-label required">Employee Name</label>
                                    <input type="text" class="form-control" id="employeeName" name="employeeName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="employeeId" class="form-label required">Employee ID</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="employeeId" name="employeeId" readonly>
                                        <button type="button" class="btn btn-outline-secondary" id="generateIdBtn">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="designation" class="form-label required">Designation</label>
                                    <select class="form-select" id="designation" name="designation" required>
                                        <option value="">Select Designation</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phoneNo" class="form-label required">Phone No</label>
                                    <input type="tel" class="form-control" id="phoneNo" name="phoneNo" required>
                                </div>
                                <div class="col-12 mb-3">
                                    <label for="address" class="form-label required">Address</label>
                                    <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label required">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                                <div class="col-md-6 mb-3" style="display:none">
                                    <label for="confirm" class="form-label">Confirm</label>
                                    <input type="text" class="form-control" id="confirm" name="confirm" value="No" readonly>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="row mt-4">
                                <div class="col-md-6 mb-2">
                                    <button type="submit" id="saveBtn" class="btn btn-success text-white w-100 py-2">
                                        <i class="fas fa-save me-2"></i>Save Employee
                                    </button>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <button type="button" class="btn btn-reset text-white w-100 py-2" id="resetBtn">
                                        <i class="fas fa-redo me-2"></i>Reset Form
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>
        // API Configuration
        const apiKey = 'AIzaSyBAuS3Brpsw5JOJnjNJii1UlFa7ClXf8d4';
        const employeeSheetId = '1V-H0J23q8RnnUi5NpF-OMAGnmaC0bYqN6VrA4_Q3XgQ';
        const designationSheetId = '1JF2aKuDLGm3jE9Dq3OAEw5S9T99f9w-wZkP0Gc6JDlQ';
        
        // Global variables
        let employeeData = [];
        let designationData = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Get user info from sessionStorage
            const userInfo = JSON.parse(sessionStorage.getItem('userInfo') || '{}');
            
            // Set values from browser storage
            document.getElementById('mainOffice').value = userInfo.mainOffice || '101';
            document.getElementById('subOffice').value = userInfo.subOffice || '101';
            
            // Set current date
            const now = new Date();
            document.getElementById('date').value = formatDate(now);
            
            // Load employee data and designation data
            loadEmployeeData();
            loadDesignationData();
            
            // Event listeners
            document.getElementById('generateIdBtn').addEventListener('click', generateEmployeeId);
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            document.getElementById('employeeForm').addEventListener('submit', submitForm);
            
            // Generate initial employee ID
            generateEmployeeId();
        });

        // Format date as dd/mm/yyyy
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Load employee data from Google Sheets
        function loadEmployeeData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${employeeSheetId}/values/data!A2:J?key=${apiKey}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.values) {
                        employeeData = data.values.map(row => ({
                            mainOffice: row[0],
                            subOffice: row[1],
                            date: row[2],
                            employeeName: row[3],
                            employeeId: row[4],
                            designation: row[5],
                            address: row[6],
                            email: row[7],
                            phoneNo: row[8],
                            confirm: row[9]
                        }));
                    }
                })
                .catch(error => {
                    console.error('Error loading employee data:', error);
                });
        }

        // Load designation data from Google Sheets
        function loadDesignationData() {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${designationSheetId}/values/Designation%20%26%20Payroll!A2:G?key=${apiKey}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.values) {
                        designationData = data.values.map(row => ({
                            mainOffice: row[0],
                            subOffice: row[1],
                            designationCode: row[2],
                            designation: row[3],
                            basicPay: row[4],
                            status: row[5],
                            confirm: row[6]
                        }));
                        
                        populateDesignationDropdown();
                    }
                })
                .catch(error => {
                    console.error('Error loading designation data:', error);
                });
        }

        // Populate designation dropdown
        function populateDesignationDropdown() {
            const mainOffice = document.getElementById('mainOffice').value;
            const subOffice = document.getElementById('subOffice').value;
            const designationSelect = document.getElementById('designation');
            
            // Clear existing options except the first one
            while (designationSelect.options.length > 1) {
                designationSelect.remove(1);
            }
            
            // Filter designations based on main office, sub office and confirm status
            const filteredDesignations = designationData.filter(item => 
                item.mainOffice === mainOffice && 
                item.subOffice === subOffice && 
                item.confirm === 'Yes'
            );
            
            // Add filtered designations to dropdown
            filteredDesignations.forEach(item => {
                const option = document.createElement('option');
                option.value = item.designation;
                option.textContent = item.designation;
                designationSelect.appendChild(option);
            });
        }

        // Generate employee ID
        function generateEmployeeId() {
            const mainOffice = document.getElementById('mainOffice').value;
            const subOffice = document.getElementById('subOffice').value;
            
            // Filter employees for the same main office and sub office
            const officeEmployees = employeeData.filter(emp => 
                emp.mainOffice === mainOffice && 
                emp.subOffice === subOffice
            );
            
            // Find the highest employee number
            let maxEmployeeNo = 0;
            officeEmployees.forEach(emp => {
                // Extract the numeric part from employee ID (format: mainOffice + subOffice + 0 + number)
                const idParts = emp.employeeId.match(new RegExp(`^${mainOffice}${subOffice}0(\\d+)$`));
                if (idParts && idParts[1]) {
                    const employeeNo = parseInt(idParts[1]);
                    if (employeeNo > maxEmployeeNo) {
                        maxEmployeeNo = employeeNo;
                    }
                }
            });
            
            // Generate new employee ID
            const newEmployeeNo = maxEmployeeNo + 1;
            const employeeId = `${mainOffice}${subOffice}0${newEmployeeNo.toString().padStart(3, '0')}`;
            
            document.getElementById('employeeId').value = employeeId;
            return employeeId;
        }

        // Reset form
        function resetForm() {
            document.getElementById('employeeForm').reset();
            
            // Reset readonly fields
            const now = new Date();
            document.getElementById('date').value = formatDate(now);
            document.getElementById('confirm').value = 'No';
            
            // Regenerate employee ID
            generateEmployeeId();
            
            // Repopulate designation dropdown
            populateDesignationDropdown();
        }

        // Submit form
        function submitForm(event) {
            event.preventDefault();
            
            const submitButton = document.getElementById("saveBtn");
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            
            // Prepare form data
            const formData = {
                mainOffice: "'"+document.getElementById('mainOffice').value,
                subOffice: "'"+document.getElementById('subOffice').value,
                date: "'"+document.getElementById('date').value,
                employeeName: document.getElementById('employeeName').value,
                employeeId: "'"+document.getElementById('employeeId').value,
                designation: document.getElementById('designation').value,
                address: document.getElementById('address').value,
                email: document.getElementById('email').value,
                phoneNo:"'"+ document.getElementById('phoneNo').value,
                confirm: document.getElementById('confirm').value
            };
            
            // Submit to Google Sheets
            const urlEncodedData = new URLSearchParams(formData).toString();
            
            fetch('https://script.google.com/macros/s/AKfycbxD6QVHZXmHu7sU2VjODcZWt2ry7rLFGriKff1z_Q1xHrjfrVlM5VTP_l8LXtGTw2IRfw/exec', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: urlEncodedData
            })
            .then(response => {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Employee';
                
                Swal.fire({
                    title: 'Success!',
                    text: 'Employee registered successfully!',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    resetForm();
                });
            })
            .catch(error => {
                console.error('Error:', error);
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save me-2"></i>Save Employee';
                
                Swal.fire({
                    title: 'Error!',
                    text: 'There was an issue saving the employee data. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            });
        }

        // Phone number validation
        document.getElementById('phoneNo').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // Email validation
        document.getElementById('email').addEventListener('blur', function(e) {
            const email = this.value;
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (email && !emailPattern.test(email)) {
                Swal.fire({
                    title: 'Invalid Email!',
                    text: 'Please enter a valid email address.',
                    icon: 'warning',
                    confirmButtonText: 'OK'
                });
                this.focus();
            }
        });
    </script>
</body>
</html>
